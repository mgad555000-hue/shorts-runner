# Shorts Runner - توثيق كامل للمشروع

## الهدف من المشروع
تطبيق منفصل لإنشاء الفيديوهات القصيرة (Shorts) والطويلة لعدة قنوات يوتيوب. يعمل بنظام الوصفات (Recipes) مع محرك ذكاء صناعي موحد (engine.py).

## الريبو
- GitHub: https://github.com/mgad555000-hue/shorts-runner
- البورت: 8001
- المشروع الأصلي (الفيديوهات الطويلة): https://github.com/mgad555000-hue/python-runner (بورت 8000)

---

## البنية التقنية

### التقنيات
- Backend: Python + FastAPI
- Database: SQLite + SQLAlchemy
- Frontend: Vanilla HTML/CSS/JS (عربي RTL)
- Container: Docker + Docker Compose
- Execution: Docker Sandbox أو Local subprocess

### هيكل الملفات
```
shorts-runner/
  app/
    __init__.py
    main.py          ← FastAPI backend + نظام القنوات
    database.py      ← SQLite models (Recipe, Run, Setting)
    models.py        ← Pydantic API models
    sandbox.py       ← Docker/Local code executor
    engine.py        ← محرك الذكاء الصناعي الموحد (6 دوال)
  static/
    index.html       ← الواجهة (تصميم وردي، عربي RTL، responsive)
  data/
    channels/        ← مجلدات القنوات
      My_Kidney/
        videos_list.xlsx
        videos/      ← mount من الهارد الخارجي
      Alhashab2000/
        videos_list.xlsx
        videos/
      Social_relations/
        videos_list.xlsx
        videos/
  recipes/           ← ملفات الوصفات
  shorts/out/        ← مخرجات التشغيلات
  BUILD_DOCUMENT.md  ← وثيقة البناء (موديلات + كود مجرب)
  ENGINE_BUILD_PLAN.md ← خطة بناء المكتبة
  docker-compose.yml
  Dockerfile
  sandbox.Dockerfile
  requirements.txt
  .env               ← مفاتيح API (مش على GitHub)
```

---

## نظام القنوات

### الفكرة
- كل قناة مجلد منفصل في `data/channels/`
- الواجهة فيها dropdown لاختيار القناة
- كل وصفة لما تشتغل على قناة معينة:
  - بتقرأ من: `channels/<قناة>/<وصفة>/input/`
  - بتكتب في: `channels/<قناة>/<وصفة>/output/`
  - بتوصل لفيديوهات: `channels/<قناة>/videos/`
- إضافة قناة جديدة = مجلد جديد + ملف Excel + فيديوهات

### القنوات الحالية
1. **My_Kidney** - قناة الكلى (222 فيديو توضيحي)
2. **Alhashab2000** - قناة الهشاب (345 فيديو)
3. **Social_relations** - قناة العلاقات الاجتماعية (188+ فيديو)

### ربط الفيديوهات
الفيديوهات مربوطة من الهارد الخارجي عبر Docker mount (مش منسوخة):
```
D:/Ranner paython/ranner paython channel videos lists/Alhashab2000 → /app/data/channels/Alhashab2000/videos
D:/Ranner paython/ranner paython channel videos lists/My_Kidney → /app/data/channels/My_Kidney/videos
D:/Ranner paython/ranner paython channel videos lists/Social_relations → /app/data/channels/Social_relations/videos
```

---

## محرك الذكاء الصناعي (engine.py)

### الفكرة الأساسية
ملف واحد فيه دوال مجربة للتعامل مع كل موديلات الذكاء الصناعي. الوصفات بتستدعي الدوال دي وبس - مش بتتعامل مع الموديلات مباشرة. ده بيمنع أخطاء الربط المتكررة.

### الدوال الستة
| # | الدالة | الوظيفة | الحالة |
|---|---|---|---|
| 1 | `generate(prompt, model)` | توليد نص | مكتملة ومجربة |
| 2 | `batch_send(prompts, model)` | إرسال دفعة | هيكل فقط - لم تُنفذ |
| 3 | `batch_retrieve(job_info)` | استقبال دفعة | هيكل فقط - لم تُنفذ |
| 4 | `tts_elevenlabs(text, voice)` | صوت ElevenLabs | هيكل فقط - لم تُنفذ |
| 5 | `tts_vertex(text, voice)` | صوت Vertex AI | هيكل فقط - لم تُنفذ |
| 6 | `transcribe(audio_file)` | Whisper | هيكل فقط - لم تُنفذ |

### دالة generate - مكتملة
- تدعم: Gemini, OpenAI (GPT-4 + GPT-5), Claude, GLM
- اختبرت على 10 موديلات ونجحت 100%
- اختبرت من الواجهة الفعلية (Docker) ونجحت
- بتتعامل تلقائياً مع فرق GPT-5 (max_completion_tokens بدل max_tokens)
- بتتعامل تلقائياً مع GPT-5-nano (مش بيقبل temperature غير 1)

### البنية الأساسية - مكتملة
- `EngineResult` - نتيجة موحدة لكل الدوال
- `BatchInfo` - معلومات Batch موحدة مع save/load
- `EngineError` - أخطاء مع كود خطأ
- فحوصات قبل الإرسال (مفتاح، برومبت، موديل)
- نظام retry مع تمييز أخطاء مؤقتة/دائمة
- تحديد المزود تلقائي من اسم الموديل
- 40 اختبار نجحوا 100%

---

## الموديلات المدعومة والمجربة

### كلهم تم اختبارهم بنجاح (2026-02-07):
| الموديل | المزود | ملاحظة |
|---|---|---|
| gemini-2.5-flash | Gemini API | |
| gemini-2.5-pro | Gemini API | |
| gemini-3-pro-preview | Gemini API | |
| gpt-4o-mini | OpenAI | max_tokens |
| gpt-4.1-mini | OpenAI | max_tokens |
| gpt-4.1-nano | OpenAI | max_tokens |
| gpt-5-nano | OpenAI | max_completion_tokens + لا يقبل temperature |
| gpt-5-mini | OpenAI | max_completion_tokens |
| gpt-5 | OpenAI | max_completion_tokens |
| gpt-5.1 | OpenAI | max_completion_tokens |
| gpt-5.2 | OpenAI | max_completion_tokens |
| claude-sonnet-4-20250514 | Anthropic | |
| claude-opus-4-20250514 | Anthropic | |
| glm-4-plus | GLM REST | |

### مفاتيح API (في ملف .env)
- GEMINI_API_KEY
- OPENAI_API_KEY
- CLAUDE_API_KEY
- GLM_API_KEY
- GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET, GOOGLE_REFRESH_TOKEN, GOOGLE_QUOTA_PROJECT

---

## الواجهة

### العناصر الرئيسية
- **Header**: اسم التطبيق + إحصائيات مباشرة + مؤشر Mock Mode
- **4 تابات**: تشغيل، الوصفات، السجلات، إحصائيات
- **تاب التشغيل**: 3 dropdowns (وصفة + قناة + موديل) + محرر كود + أزرار (تشغيل، فتح مجلد المدخلات، مسح)
- **تاب الوصفات**: قائمة + إضافة/تعديل/حذف + إنشاء مجلدات
- **تاب السجلات**: فلترة بالحالة + تفاصيل التشغيل في modal
- **تاب إحصائيات**: dashboard + إعدادات + تنظيف يدوي

### تفاصيل التشغيل (detail panel)
- حالة التشغيل مع badge ملون
- معلومات (مجلد، بداية، انتهاء، مدة)
- عرض الـ log بخلفية داكنة
- قائمة الملفات المنتجة
- أزرار: إلغاء، تنزيل ZIP، مجلد المخرجات

### أزرار المجلدات
- زر "فتح مجلد المدخلات" بينسخ المسار المحلي تلقائي في clipboard
- زر "مجلد المخرجات" بعد اكتمال التشغيل بينسخ المسار تلقائي
- المستخدم يلصقه في File Explorer

---

## القرارات المتفق عليها

### الوصفات
1. التعليمات (البرومبت) كلها جوه كود الوصفة - مفيش ملفات خارجية
2. التعليمات عامة تصلح لأي قناة
3. مجلدات input و output فاضية تماماً - بس ملفات العمل
4. الوصفات مشتركة بين كل القنوات
5. بناء الوصفات مرحلة مرحلة وبموافقة قبل كل وصفة

### الموديل
6. يتختار من dropdown في الواجهة - مش ثابت جوه الوصفة
7. نظام الموديلات مفتوح - القائمة قابلة للتوسيع
8. الموديل بيتمرر كـ environment variable (MODEL_NAME)

### القنوات
9. كل قناة مجلد منفصل
10. إضافة قناة جديدة = مجلد جديد وخلاص
11. الفيديوهات مربوطة mount مش منسوخة

### المحرك (engine.py)
12. كود الربط بالموديلات يتكتب مرة واحدة في المكتبة ومش بيتكرر في الوصفات
13. الوصفة بتستدعي دوال المكتبة (سطر واحد) مش بتكتب كود ربط
14. 187 سيناريو خطأ تم تحديدهم
15. فحوصات قبل وأثناء وبعد كل عملية

### شرط أساسي
16. **ممنوع الاجتهاد** - أي حاجة مش منصوص عليها لازم يتم السؤال عنها
17. **ممنوع التنفيذ بدون موافقة** في المناقشات - أما أثناء العمل على مهمة فالخطوات الضرورية تتنفذ

---

## خطة البناء المتبقية

### المكتبة (engine.py) - 5 مراحل متبقية
| المرحلة | المحتوى | الحالة |
|---|---|---|
| 1 | البنية الأساسية | مكتملة (40/40) |
| 2 | دالة توليد النص | مكتملة (10/10) + اختبار واجهة |
| 3 | دالة إرسال الدفعة (Batch Send) | لم تبدأ |
| 4 | دالة استقبال الدفعة (Batch Retrieve) | لم تبدأ |
| 5 | صوت ElevenLabs | لم تبدأ |
| 6 | صوت Vertex AI | لم تبدأ |
| 7 | Whisper | لم تبدأ |
| 8 | اختبار شامل | لم تبدأ |

### بعد المكتبة - بناء الوصفات
الوصفات المطلوبة للشورتس (من وصف المستخدم):

#### مراحل إنشاء الفيديو القصير:
1. **توليد السكرائمة** - عنوان → (مقدمة رئيسية + سكريبت + قائمة فيديوهات توضيحية)
2. **توليد التكست** - عنوان → (وصف يوتيوب + تيك توك + فيسبوك + جاكو + كلمات مفتاحية + جملة شاشة)
3. **إنشاء ملفات مجمعة** - 4 ملفات وورد (مجمع المقدمات + مجمع السكريبتات + مجمع قائمة الفيديوهات + مجمع التكست)
4. **تحويل نص لصوت** (اختياري) - ElevenLabs
5. **تجميع الفيديوهات التوضيحية** - نسخ من المجلد الرئيسي
6. **مونتاج الفيديو القصير** - تركيب (ثلث علوي: نص + ثلث أوسط: فيديوهات + ثلث سفلي: فيديو/صورة المذيع)

#### مراحل إنشاء الفيديو الطويل:
1. **توليد السكريبت الكامل** - عنوان → (مقدمة رئيسية + 4 مقدمات + 4 نصوص + قصة اختياري)
2. **توليد التكست** - وصف + كلمات مفتاحية + ترجمات
3. **إنشاء ملفات مجمعة** - (مجمع السكريبتات + مجمع النصوص + مجمع القصص)
4. **تحويل نصوص لصوت** - 4 ملفات صوت
5. **إنشاء قائمة فيديوهات توضيحية** - AI يختار من القائمة المتاحة
6. **تجميع الفيديوهات** - نسخ من المجلد الرئيسي
7. **مونتاج الفيديو الطويل** - تركيب الفيديو الكامل

#### مونتاج الفيديو الطويل - الترتيب:
- **الافتراضي** (My_Kidney + Alhashab2000): مقدمة رئيسية → مقدمة 1 → صوت 1 + فيديوهات → مقدمة 2 → صوت 2 + فيديوهات → مقدمة 3 → صوت 3 + فيديوهات → مقدمة 4 → صوت 4 + فيديوهات → خاتمة
- **Social Relations**: مقدمة رئيسية → فيديو القصة → مقدمة 1 → ... → خاتمة
- **3 بدائل**: صوت AI + فيديوهات (افتراضي) / فيديو مصور / صوت مسجل + فيديوهات

#### مونتاج الفيديو القصير:
- الفيديو بالطول (Portrait)
- الشاشة مقسمة 3 أقسام متساوية
- احتمالين: مع تقديمة المذيع أو بدونها
- القسم العلوي: خلفية سوداء + جملة الشاشة (أبيض/أصفر - اختيار المستخدم)
- القسم الأوسط: فيديوهات توضيحية بالتوالي
- القسم السفلي: فيديو المذيع أو صورة + صوت (اختيار المستخدم)

---

## ملفات مرجعية مهمة
- `BUILD_DOCUMENT.md` - كل الموديلات وكود الربط المجرب لكل واحد
- `ENGINE_BUILD_PLAN.md` - خطة بناء المكتبة بالتفصيل
- وصفات python-runner (`c:\python-runner\recipes\`) - مرجع لكود مجرب وناجح

---

## معلومات التشغيل
- Docker Compose: `docker-compose up --build -d`
- البورت: 8001
- الواجهة: http://localhost:8001
- Git user: mgad555000-hue / mgad555000@gmail.com
