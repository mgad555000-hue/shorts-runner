# خطة بناء المكتبة (engine.py)

## الاستراتيجية: بناء واختبار كل دالة منفردة قبل الانتقال للتالية

---

## المرحلة 1: البنية الأساسية
**نبني الهيكل العام بدون أي ربط بموديلات:**
- ملف engine.py
- نظام الأخطاء الموحد (رسائل واضحة بالعربي)
- دالة الفحص قبل الإرسال (مفتاح موجود؟ برومبت مش فاضي؟)
- دالة إعادة المحاولة الموحدة (retry مع انتظار تدريجي)
- نظام تسجيل الأحداث (log كل خطوة)

**الاختبار:** نتأكد إن البنية شغالة بدون أخطاء

---

## المرحلة 2: دالة توليد النص (generate)
**نبنيها موديل موديل:**

### الخطوة 2.1: Gemini
- نكتب كود الربط (منسوخ حرفياً من الكود المجرب)
- نجربه بأبسط برومبت
- نجربه ببرومبت عربي طويل
- نجربه ببرومبت فاضي (لازم يرفض)
- نجربه بمفتاح غلط (لازم يعطي رسالة واضحة)

### الخطوة 2.2: OpenAI (GPT-4 + GPT-5)
- نفس الاختبارات
- نتأكد من فرق max_tokens vs max_completion_tokens

### الخطوة 2.3: Claude
- نفس الاختبارات

### الخطوة 2.4: GLM
- نفس الاختبارات

**الاختبار النهائي للمرحلة 2:** نشغل كل الموديلات بنفس البرومبت ونتأكد كلهم يرجعوا نتيجة صحيحة

---

## المرحلة 3: دالة إرسال الدفعة (batch_send)
**نبنيها مزود مزود:**

### الخطوة 3.1: Gemini Batch
- نكتب كود الإرسال (من الكود المجرب)
- نجرب إرسال 2 برومبت
- نتأكد إن رقم المهمة اتسجل
- نتأكد إن ملف batch_info اتحفظ صح

### الخطوة 3.2: Claude Batch
- نفس الاختبارات

**الاختبار النهائي للمرحلة 3:** إرسال ناجح + ملف batch_info محفوظ وقابل للقراءة

---

## المرحلة 4: دالة استقبال الدفعة (batch_retrieve)

### الخطوة 4.1: Gemini Batch Retrieve
- نقرأ ملف batch_info
- نتحقق من حالة المهمة
- نستقبل النتائج
- نتأكد إن عدد النتائج = عدد الطلبات
- نتأكد إن كل نتيجة فيها محتوى

### الخطوة 4.2: Claude Batch Retrieve
- نفس الاختبارات

**الاختبار النهائي للمرحلة 4:** إرسال من المرحلة 3 + استقبال من المرحلة 4 = دورة كاملة ناجحة

---

## المرحلة 5: دالة صوت ElevenLabs (tts_elevenlabs)
- نكتب كود الربط
- نجرب بنص قصير
- نجرب بنص عربي طويل
- نتأكد إن ملف الصوت مش فاضي
- نتأكد من صيغة الملف

---

## المرحلة 6: دالة صوت Vertex AI (tts_vertex)
- نكتب كود الربط (من الكود المجرب)
- نفس اختبارات المرحلة 5

---

## المرحلة 7: دالة Whisper (transcribe)
- نكتب كود الربط
- نجرب بملف صوت حقيقي
- نتأكد إن النص مش فاضي

---

## المرحلة 8: الاختبار الشامل
- نشغل كل الدوال الستة في سيناريو واقعي
- نتأكد إن رسائل الأخطاء واضحة ومفيدة
- نتأكد إن الـ retry بيشتغل صح
- نتأكد إن الـ timeout بيشتغل صح

---

## القواعد الثابتة أثناء البناء

1. **كل كود ربط بموديل يتنسخ حرفياً من الكود المجرب في وثيقة البناء**
2. **كل دالة تتجرب فردياً قبل الانتقال للتالية**
3. **لو دالة فشلت نصلحها قبل ما نكمل**
4. **كل اختبار لازم ينجح فعلياً مش نظرياً**
5. **مفيش اجتهاد - كل حاجة من المرجع**
6. **بعد كل مرحلة نسأل المستخدم قبل ما نكمل**

---

## النتيجة المتوقعة

ملف engine.py واحد فيه 6 دوال مجربة وجاهزة.
أي وصفة جديدة بتستدعي الدوال دي وخلاص.
